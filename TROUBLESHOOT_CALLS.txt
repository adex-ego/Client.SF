üîß GUIDE DE D√âPANNAGE - APPELS AUDIO/VID√âO
============================================

PROBL√àME: Les appels audio et vid√©o ne fonctionnent pas, la messagerie fonctionne

DIAGNOSTICS √Ä V√âRIFIER:
========================

1Ô∏è‚É£ V√âRIFICATION DES LOGS
------------------------
Lors du clic sur "Appel Audio" ou "Appel Vid√©o", recherchez ces messages dans la console:

‚úÖ MESSAGES ATTENDUS (succ√®s):
   üéôÔ∏è Clic sur bouton appel audio vers [contact]
   Tentative d'appel audio vers [contact]
   WebSocket connect√©: true
   üì§ Envoi message CALL_INITIATE: {...}
   ‚úÖ Message CALL_INITIATE envoy√© avec succ√®s

‚ùå PROBL√àMES POSSIBLES:
   - "WebSocket connect√©: false" ‚Üí Probl√®me de connexion au serveur
   - "Erreur envoi appel: ..." ‚Üí Impossible d'envoyer le message
   - Pas de r√©ponse du serveur ‚Üí Serveur ne traite pas le message


2Ô∏è‚É£ DIAGNOSTICS POSSIBLES
--------------------------

A) PROBL√àME DE WEBSOCKET
   Sympt√¥mes:
   - Message "WebSocket connect√©: false" lors d'un appel
   - La messagerie marche mais pas les appels
   
   Solutions:
   - V√©rifier que le serveur re√ßoit bien le message LOGIN_RESPONSE avec succ√®s
   - V√©rifier que la connexion au port 8081 reste active
   - Essayer de envoyer un message texte apr√®s le login (messagerie)
   
   Code affect√©:
   - ConnectionManager.java:initiateCall() v√©rifie chatClient.isConnected()
   - WebSocketClient.java:send() lance Exception si not connected


B) PROBL√àME D'ENVOI DE MESSAGE
   Sympt√¥mes:
   - Erreur "Erreur envoi appel: ..." dans les logs
   
   Solutions:
   - V√©rifier l'exception compl√®te (impression de stack trace)
   - V√©rifier que le message CALL_INITIATE est s√©rialis√© correctement
   
   Code affect√©:
   - ConnectionManager.java:initiateCall() ligne ~150
   - ConnectionManager.java:acceptCall() ligne ~170


C) PROBL√àME DE D√âMARRAGE AUDIO/VID√âO
   Sympt√¥mes:
   - Message d'appel envoy√©, mais pas de flux audio/vid√©o
   - Erreurs "Erreur d√©marrage m√©dia: ..."
   
   Solutions:
   - V√©rifier que les clients audio/vid√©o peuvent se connecter aux ports:
     * Port 50000 (audio) - DatagramSocket/UDP
     * Port 50020 (vid√©o) - DatagramSocket/UDP
   - V√©rifier que le serveur a d√©marr√© les listeners sur ces ports
   - V√©rifier les logs d√©taill√©s du d√©marrage m√©dias:
     "Configuring audio client..."
     "Starting audio receive..."
     "Starting audio capture..."
   
   Code affect√©:
   - ConnectionManager.java:acceptCall() lignes ~175-190
   - AudioClient.java:configure(), startReceiving(), startCapture()
   - VideoClient.java:configure(), start()


D) PROBL√àME C√îT√â SERVEUR
   Sympt√¥mes:
   - Message d'appel envoy√©, mais l'autre client ne re√ßoit pas CALL_INITIATE
   
   Solutions:
   - V√©rifier que le serveur:
     1. Re√ßoit bien le message CALL_INITIATE du client A
     2. Trouve bien le contact B dans sa liste
     3. Envoie CALL_INITIATE au client B
   - V√©rifier les logs du serveur pour voir les erreurs


3Ô∏è‚É£ FLUX D'APPEL ATTENDU
--------------------------

Client A (qui appelle):
  1. Clic "Appel Audio"
  2. initiateCall() ‚Üí Envoie CALL_INITIATE au serveur
  3. Attend CALL_ACCEPT du serveur (envoy√© par Client B)

Client B (qui re√ßoit):
  1. Re√ßoit CALL_INITIATE du serveur
  2. handler CALL_INITIATE ‚Üí Appelle listener.onCallIncoming()
  3. Interface affiche dialog "Appel entrant de A"
  4. Clic "Accepter" ‚Üí Envoie CALL_ACCEPT au serveur
  5. De son c√¥t√©, d√©marre audioClient/videoClient

Serveur:
  1. Re√ßoit CALL_INITIATE de A ‚Üí Notifie B
  2. Re√ßoit CALL_ACCEPT de B ‚Üí Notifie A et active flux RTC
  3. Les deux clients re√ßoivent CALL_ACCEPT et d√©marrent leurs flux


4Ô∏è‚É£ POINTS DE V√âRIFICATION DE CODE
----------------------------------

Pour v√©rifier manuellement:

‚úì Les messages types existent:
  MessageType.CALL_INITIATE
  MessageType.CALL_ACCEPT
  MessageType.CALL_REJECT
  MessageType.CALL_END

‚úì Le listener est bien enregistr√©:
  SecurePhoneApp.java ‚Üí setupConnectionListeners()
  Doit appeler: connectionManager.setCallListener(new ConnectionManager.CallListener() {...})

‚úì Les clients audio/vid√©o sont cr√©√©s:
  ConnectionManager.java ligne ~58:
  - private final AudioClient audioClient = new AudioClient();
  - private final com.securephone.client.video.VideoClient videoClient = new com.securephone.client.video.VideoClient();

‚úì Les callbacks UI sont appel√©s:
  Rechercher "onCallIncoming", "onCallAccepted", "onCallEnded" dans SecurePhoneApp.java
  Doit afficher un dialog ou changer l'interface


5Ô∏è‚É£ COMMANDES DE TEST
---------------------

Test 1: V√©rifier la connexion WebSocket
$ nc -zv 10.19.174.48 8081
(devrait afficher: "Connection successful" ou "open")

Test 2: V√©rifier les ports UDP (serveur doit les avoir ouvert)
$ nc -zu 10.19.174.48 50000   # Audio
$ nc -zu 10.19.174.48 50020   # Vid√©o
(devrait montrer une r√©action quelconque ou timeout)

Test 3: V√©rifier les logs compl√®tement
$ mvn exec:java -Dexec.mainClass="com.securephone.client.SecurePhoneApp" 2>&1 | tee app.log
Puis faire un appel et sauvegarder app.log pour analyse


6Ô∏è‚É£ CHECKLIST POUR D√âBOGAGER
-----------------------------

Avant d'appeler:
  ‚ñ° Deux clients authentifi√©s avec des usernames diff√©rents
  ‚ñ° Les deux clients voient les contacts dans la liste
  ‚ñ° Les boutons d'appel sont activ√©s (pas gris√©s)
  ‚ñ° Pas d'erreurs de connexion dans les logs

Lors du clic sur "Appel Audio":
  ‚ñ° Message "üéôÔ∏è Clic sur bouton appel audio vers [contact]" dans logs
  ‚ñ° Message "Tentative d'appel audio vers [contact]" dans logs
  ‚ñ° Message "WebSocket connect√©: true" dans logs
  ‚ñ° Message "‚úÖ Message CALL_INITIATE envoy√© avec succ√®s" dans logs
  ‚ñ° Message "[SYSTEM]: Appel audio initialis√© avec [contact]..." dans la zone chat

C√¥t√© autre client:
  ‚ñ° Aucun message d'erreur re√ßu
  ‚ñ° Si tout va bien: dialog "Appel entrant" devrait afficher
  ‚ñ° Si dialog affiche, client peut "Accepter" ou "Rejeter"

Si "Accepter" cliqu√©:
  ‚ñ° Message "‚úÖ Message CALL_ACCEPT envoy√©" dans logs du Client B
  ‚ñ° Client A re√ßoit CALL_ACCEPT et affiche "‚úÖ Appel accept√© par..."
  ‚ñ° D√©marrage des flux: "Configuring audio client...", etc.
  ‚ñ° Apr√®s ~2-3 secondes: "‚úÖ Flux audio d√©marr√©"


7Ô∏è‚É£ FICHIERS √Ä EXAMINER
-----------------------

Si vous devez √©tudier le code:

1. SecurePhoneApp.java:
   - setupConnectionListeners() - Enregistrer CallListener
   - Listener impl√©mente: onCallIncoming, onCallAccepted, etc.

2. ConnectionManager.java:
   - initiateCall() - Envoyer CALL_INITIATE
   - acceptCall() - Envoyer CALL_ACCEPT et d√©marrer m√©dias
   - rejectCall() - Envoyer CALL_REJECT
   - endCall() - Envoyer CALL_END et arr√™ter m√©dias
   - handleMessage() - Traiter CALL_INITIATE/ACCEPT/REJECT/END

3. AppPage.java:
   - initiateAudioCall() / initiateVideoCall() - Appels UI
   - Boutons sont attach√©s √† ces m√©thodes

4. AudioClient.java & VideoClient.java:
   - configure(host, port, userId) - Initialiser
   - Attention: Utilisent DatagramSocket (UDP), pas TCP!


R√âSUM√â:
========

Les appels audio/vid√©o d√©pendent d'une cha√Æne:
1. Message CALL_INITIATE envoy√© via WebSocket (TCP port 8081) ‚úÖ Cod√©
2. Serveur route le message au destinataire
3. Destinataire re√ßoit et affiche dialog
4. Destinataire envoie CALL_ACCEPT via WebSocket
5. Appelant re√ßoit CALL_ACCEPT
6. Les deux d√©marrent AudioClient/VideoClient (UDP ports 50000/50020)

Si l'√©tape 1 √©choue ‚Üí Le probl√®me est dans ConnectionManager ou WebSocket
Si l'√©tape 2-4 √©chouent ‚Üí Le probl√®me est serveur/r√©seau
Si l'√©tape 6 √©choue ‚Üí Le probl√®me est AudioClient/VideoClient ou ports ferm√©s
